<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="referrer" content="always" />
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,shrink-to-fit=no,user-scalable=no,minimal-ui" />
  <title>EOS MultiSig Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
  <script>window.jQuery || document.write('<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" type="text/javascript"><\/script>')</script>
  <script>
$(document).ready(function() {
  const url = $('#url').val()

  $('#parametersTemplate').click(() => {
    fetch(url + '/v1/chain/get_abi', {
        method: 'POST'
        , headers: {
          accept: "application/json",
          "content-type": "application/json"
        }
        , body: JSON.stringify({
          account_name: $('#contract').val()
        })
      })
      .then((res) => {
        if (res.status == 200) {
          return res.json()
        }
        return null
      })
      .then((jo) => {
        $('#parameters').val(makeParameters(jo))
      })
      .catch((err) => {
        $('#result').val(err)
      })
  })

  $('#generateCommand').click(() => {
    fetch(url + '/v1/chain/get_account', {
        method: 'POST'
        , headers: {
          accept: "application/json",
          "content-type": "application/json"
        }
        , body: JSON.stringify({
          account_name: $('#actor').val()
        })
      })
      .then((res) => {
        if (res.status == 200) {
          return res.json()
        }
        return null
      })
      .then((jo) => {
        $('#result').val(makeCommand(jo))
      })
      .catch((err) => {
        $('#result').val(err)
      })
  })

  const makeParameters = (abi) => {
    if (abi && abi.abi && abi.abi.structs) {
      const action = $('#action').val()
      for (let s of abi.abi.structs) {
        if (s.name === action) {
          const result = {}
          for (let e of s.fields) {
            result[e.name] = e.type
          }
          return JSON.stringify(result)
        }
      }
    }
    return null
  }

  const makeCommand = (account) => {
    if (account && account.permissions) {
      const permission = $('#permission').val()
      for (let p of account.permissions) {
        if (p.perm_name == permission) {
          const result = []
          for (let a of p.required_auth.accounts) {
            result.push(a.permission)
          }
          return 'cleos -u ' + url + ' multisig propose '
            + $('#proposal_name').val() + " '" + JSON.stringify(result)
            + '\' \'[{"actor":"' + $('#actor').val() + '","permission":"'
            + permission + '"}]\' ' + $('#contract').val() + ' '
            + $('#action').val() + ' \'' + $('#parameters').val() + '\''
        }
      }
    }
    return null
  }
})
  </script>
  <link rel="stylesheet" href="./css/common.css?20191111"/>
</head>

<body>
  <noscript>
    <strong>We're sorry but EOS MultiSig Generator doesn't work properly without JavaScript enabled. Please enable it to
      continue.</strong>
  </noscript>

  <div class="container">
    <div class="block">
      <div class="input-wrapper">URL:</div>
      <div class="longtext-wrapper">
        <textarea class="longtext" id="url">https://mainnet.meet.one</textarea>
      </div>
      <div class="input-wrapper">
        Proposal name: <input type="text" class="eosname" id="proposal_name" maxlength="12" value="transfer" />
      </div>
      <div class="input-wrapper">
        Auth: <input type="text" class="eosname" id="actor" maxlength="12" value="eosiomeetone" />@<input type="text" class="eosname" id="permission" maxlength="12" value="active" />
      </div>
      <div class="input-wrapper">
        Contract: <input type="text" class="eosname" id="contract" maxlength="12" value="eosio.token" />
        Action: <input type="text" class="eosname" id="action" maxlength="12" value="transfer" />
      </div>
      <div class="input-wrapper">
        Parameters: <button class="small-button" id="parametersTemplate">Parameters Template</button>
      </div>
      <div class="longtext-wrapper">
        <textarea class="longtext" id="parameters">{}</textarea>
      </div>
      <div class="button-wrapper">
        <button id="generateCommand">Generate cleos command</button>
      </div>
      <div>
        <textarea class="resulttext" id="result" cols="60" rows="40"></textarea>
      </div>
      <div class="footer">
        <a class="opensource" href="https://github.com/UMU618/eos-multisig-generator" target="_blank">View source code</a>
      </div>
    </div>
  </div>
</body>

</html>